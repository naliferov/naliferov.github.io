<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="icon" type="image/png" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IS0tIFVwbG9hZGVkIHRvOiBTVkcgUmVwbywgd3d3LnN2Z3JlcG8uY29tLCBHZW5lcmF0b3I6IFNWRyBSZXBvIE1peGVyIFRvb2xzIC0tPg0KPHN2ZyB3aWR0aD0iODAwcHgiIGhlaWdodD0iODAwcHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4NCjxwYXRoIGQ9Ik03LjkwNDUxIDYuOTIxNDRDOC40MTM0MSA2LjQ1NDk1IDguNDQ3NzkgNS42NjQyNCA3Ljk4MTMgNS4xNTUzNEM3LjUxNDgxIDQuNjQ2NDUgNi43MjQxIDQuNjEyMDcgNi4yMTUyIDUuMDc4NTZMNy45MDQ1MSA2LjkyMTQ0Wk0xLjQ2MTk0IDExLjEzMTRMMi4zMDY2IDEyLjA1MjlMMi4zMDY2IDEyLjA1MjlMMS40NjE5NCAxMS4xMzE0Wk0xLjQ2MTk0IDExLjg2ODZMMi4zMDY2IDEwLjk0NzFMMi4zMDY2IDEwLjk0NzFMMS40NjE5NCAxMS44Njg2Wk02LjIxNTIgMTcuOTIxNEM2LjcyNDEgMTguMzg3OSA3LjUxNDgxIDE4LjM1MzYgNy45ODEzIDE3Ljg0NDdDOC40NDc3OSAxNy4zMzU4IDguNDEzNDEgMTYuNTQ1IDcuOTA0NTEgMTYuMDc4Nkw2LjIxNTIgMTcuOTIxNFpNNi4yMTUyIDUuMDc4NTZMMC42MTcyODcgMTAuMjFMMi4zMDY2IDEyLjA1MjlMNy45MDQ1MSA2LjkyMTQ0TDYuMjE1MiA1LjA3ODU2Wk0wLjYxNzI4NyAxMi43OUw2LjIxNTIgMTcuOTIxNEw3LjkwNDUxIDE2LjA3ODZMMi4zMDY2IDEwLjk0NzFMMC42MTcyODcgMTIuNzlaTTAuNjE3Mjg3IDEwLjIxQy0wLjEzOTM1NiAxMC45MDM2IC0wLjEzOTM1NiAxMi4wOTY0IDAuNjE3Mjg3IDEyLjc5TDIuMzA2NiAxMC45NDcxQzIuNjMwODcgMTEuMjQ0NCAyLjYzMDg3IDExLjc1NTYgMi4zMDY2IDEyLjA1MjlMMC42MTcyODcgMTAuMjFaIiBmaWxsPSIjMDAwMDAwIi8+DQo8cGF0aCBkPSJNMTYuMDU1NyAxNi4wNzg2QzE1LjU0NjggMTYuNTQ1IDE1LjUxMjUgMTcuMzM1OCAxNS45Nzg5IDE3Ljg0NDdDMTYuNDQ1NCAxOC4zNTM2IDE3LjIzNjEgMTguMzg3OSAxNy43NDUgMTcuOTIxNEwxNi4wNTU3IDE2LjA3ODZaTTIyLjQ5ODMgMTEuODY4NkwyMS42NTM3IDEwLjk0NzFMMjEuNjUzNyAxMC45NDcxTDIyLjQ5ODMgMTEuODY4NlpNMjIuNDk4MyAxMS4xMzE0TDIxLjY1MzcgMTIuMDUyOUwyMS42NTM3IDEyLjA1MjlMMjIuNDk4MyAxMS4xMzE0Wk0xNy43NDUgNS4wNzg1NkMxNy4yMzYxIDQuNjEyMDcgMTYuNDQ1NCA0LjY0NjQ1IDE1Ljk3OSA1LjE1NTM0QzE1LjUxMjUgNS42NjQyNCAxNS41NDY4IDYuNDU0OTUgMTYuMDU1NyA2LjkyMTQ0TDE3Ljc0NSA1LjA3ODU2Wk0xNy43NDUgMTcuOTIxNEwyMy4zNDMgMTIuNzlMMjEuNjUzNyAxMC45NDcxTDE2LjA1NTcgMTYuMDc4NkwxNy43NDUgMTcuOTIxNFpNMjMuMzQzIDEwLjIxTDE3Ljc0NSA1LjA3ODU2TDE2LjA1NTcgNi45MjE0NEwyMS42NTM3IDEyLjA1MjlMMjMuMzQzIDEwLjIxWk0yMy4zNDMgMTIuNzlDMjQuMDk5NiAxMi4wOTY0IDI0LjA5OTYgMTAuOTAzNiAyMy4zNDMgMTAuMjFMMjEuNjUzNyAxMi4wNTI5QzIxLjMyOTQgMTEuNzU1NiAyMS4zMjk0IDExLjI0NDQgMjEuNjUzNyAxMC45NDcxTDIzLjM0MyAxMi43OVoiIGZpbGw9IiMwMDAwMDAiLz4NCjxwYXRoIGQ9Ik0xNS4yMTI3IDMuODAzMTdDMTUuMzgwMSAzLjEzMzQzIDE0Ljk3MjkgMi40NTQ3NiAxNC4zMDMyIDIuMjg3MzJDMTMuNjMzNCAyLjExOTg5IDEyLjk1NDggMi41MjcwOSAxMi43ODczIDMuMTk2ODNMMTUuMjEyNyAzLjgwMzE3Wk04Ljc4NzMyIDE5LjE5NjhDOC42MTk4OSAxOS44NjY2IDkuMDI3MDkgMjAuNTQ1MiA5LjY5NjgzIDIwLjcxMjdDMTAuMzY2NiAyMC44ODAxIDExLjA0NTIgMjAuNDcyOSAxMS4yMTI3IDE5LjgwMzJMOC43ODczMiAxOS4xOTY4Wk0xMi43ODczIDMuMTk2ODNMOC43ODczMiAxOS4xOTY4TDExLjIxMjcgMTkuODAzMkwxNS4yMTI3IDMuODAzMTdMMTIuNzg3MyAzLjE5NjgzWiIgZmlsbD0iIzAwMDAwMCIvPg0KPC9zdmc+">
        <title>varcraft</title>
    </head>
    <body>
        <script type="module">
const mainPage = async () => {
  const r = indexedDB.open('sys')
  const storageName = 'objects'

  r.onsuccess = async() => {
    const db = r.result
    const t = db.transaction(storageName, 'readonly').objectStore(storageName).get('sys-main')

    t.onsuccess = async () => {
      let o = t.result
      if (!o) {
        const { objects } = await(await fetch('/dump.json')).json()
        for (const obj of objects) {
          db.transaction(storageName, 'readwrite').objectStore(storageName).put(obj, obj.id)
        }
        o = objects.find(o => o.id === 'sys-main')
      }
      (await import(URL.createObjectURL(new Blob([
        `export default async ($) => { 
          ${o.data.code}
        }`
      ], { type: 'application/javascript' })))).default()
    }
  }
  r.onupgradeneeded = () => {
    const db = r.result
    if (!db.objectStoreNames.contains(storageName)) db.createObjectStore(storageName)
  }
  r.onerror = () => console.error(r.error)
}
const safeModePage = async () => {

  const { promise: promiseDb, resolve: resolveDb, reject: rejectDb } = Promise.withResolvers()

  const rq = indexedDB.open('sys')
  rq.onsuccess = () => resolveDb(rq.result)
  rq.onupgradeneeded = () => {
    const db = rq.result
    const storageName = 'objects'
    if (!db.objectStoreNames.contains(storageName)) {
      resolveDb(db)
    }
  }
  const db = await promiseDb

  const t = db.transaction('objects', 'readonly').objectStore('objects').get('sys-main')
  t.onsuccess = () => {
    const l = localStorage
    const sysMain = t.result
    const p = document.createElement('pre')
    const s = p.style

    s.fontFamily = 'monospace'
    s.fontSize = '14px'
    s.padding = '10px'
    s.backgroundColor = '#f0f0f0'
    s.height = window.innerHeight + 'px'
    s.overflow = 'scroll'

    p.contentEditable = true
    p.innerText = sysMain.data.code
    p.addEventListener('keyup', (e) => {
      e.preventDefault()
      sysMain.data.code = p.innerText
      db.transaction('objects', 'readwrite').objectStore('objects').put(sysMain, sysMain.id)
    })
    p.addEventListener('scroll', (e) => l.setItem('sys-main-scroll', e.target.scrollTop))
    document.body.appendChild(p)
    p.scrollTop = l.getItem('sys-main-scroll')
  }
  t.onerror = () => console.error(t.error)
}

const main = () => {
  if (location.hash === '#safemode') safeModePage()
  else mainPage()
}
main()
        </script>
    </body>
</html>